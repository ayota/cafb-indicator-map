# Detailed demographics by iterative proportional fitting (IPF)

The code in this directory generates estimates of the joint distribution of 
demographic variables (sex, age, race, income) at the census tract level based
on two data sources:

- Marginal distribution of one or two variables at the census tract level
  (~ a few thousands people) from the American Community Survey (ACS) 
- Individual-level data from the Public Use Microdata Samples (PUMS) given at the
  larger scale of Public Use Microdata Area (PUMA) ~100,000 people

These distributions will then be input into the risk factor models developed with 
the BRFSS (Behavioral Risk Factor Surveillance System) data to compute aggregate
risk factors (e.g. for diabetes, heart disease) for each census tract.

This code implements the two-step iterative proportional fitting (IPF) method described in:

Beckman, R.J., Baggerly, K.A. and McKay, M.D. (1996) "Creating synthetic
baseline populations." Transportation Research Part A 30, 415-429.


## Data needs

Prior to running the `pums_data_prep.R` script, PUMS (microdata) files must be
downloaded from: http://www2.census.gov/programs-surveys/acs/data/pums/2014/5-Year/ .

The required files include person-level (`csv_p[..].zip`) and household-level
(`csv_h[..].zip`) records where [..] is the state abbreviation (i.e. dc, md or va).

ACS data tables are downloaded as part of the `acs_data_prep.R` script using the
`acs` package in R.


## Helper files

`income_map.csv`, `race_map.csv`, `sex_age_map.csv`: Used in `acs_data_prep.R` to map variable codes from the ACS data tables to the categories present in BRFSS.

`state_counties.csv`: List of state and counties for which estimates are desired,
based on the area served by the CAFB (Capital Area Food Bank)

`tract_puma_map.csv`: Links each census tract to the corresponding PUMA. This
file was downloaded from: http://www.census.gov/geo/maps-data/data/centract_rel.html .


## Process overview

**pums\_data\_prep.R**

For each of the three states (DC, MD and VA), processes the raw
PUMS microdata (individual rows for each person / household) to extract the variables
of interest (sex, age, race, household income), match to categories from BRFSS
and compute the aggregated counts for each PUMA and combination of demographic variables.

This script also outputs the mean household size by household income bracket in order
to help convert ACS household counts to person counts (see below).

Notes:

- The first two years of the 5-year PUMS (2010, 2011) use the old (2000) PUMA
delinations, which may not overlap with the same census tracts as the 2010 PUMA. 
Therefore, we only keep the 2012-2014 records. 
- The outputs are saved in `pums_2012_2014.csv` (main file) and 
`pums_hh_2012_2014.csv` (household size by income bracket).
- While the BRFSS considers Hispanic/Latino ethnicity as a category under race, 
in the census it is a separate (yes/no) question. To match the two datasets, we 
assume that all respondents of Hispanic/Latino origin in census data (PUMS and ACS)
would fall under the "hispanic" category in BRFSS.

**acs\_data\_prep.R**

Downloads the sex by age, race/ethnicity, and household income tables from ACS, map those
categories to BRFSS categories with the `[income/race/sex_age]_map.csv` files,
tally the counts by census tract and save the output into files:
`acs2014_[income/race/sex_age].csv`.

Note:

- To run this script, you need a census API key, which can be requested at: 
http://api.census.gov/data/key_signup.html .

**ipf.R**

Using the PUMS and ACS data files generated by the previous scripts, this script
performs the two-step IPF procedure to jointly estimate the detailed demographic 
breakdown for all census tracts that are part of each PUMA.

Notes:

- Right now the calculation is only done for one PUMA to illustrate the process,
but when finalized it can easily be wrapped into a `lapply`.

- The current example doesn't use the household distribution due to the issue
detailed below.


## Ongoing issues

In BRFSS, the "income" variable given for individuals is the household income.
Getting household incomes in PUMS is not a problem (we can just join the household
and individual records by household SERIALNO). However, in ACS the household income
statistics (table B19001) are only expressed as number of households, and there is no
two-way table for household size by income class. This is why the `pums_data_prep.R`
script extracts the mean household size by income class at the PUMA level, and
`ipf.R` uses those numbers to estimate the number of individuals per income class.

When summing up those estimates across all income classes, the total is quite
close to the actual population for most census tracts, but there are some large
discrepancies. The main reason for those seem to be group quarters, e.g. student
dormitories, retirement homes, prisons, which are part of the ACS individuals data
but not the households data. One option would be to just exclude census tracts with
more than a certain % of individuals in group quarters from the analysis.

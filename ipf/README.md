# Detailed demographics by iterative proportional fitting (IPF)

The code in this directory generates estimates of the joint distribution of 
demographic variables (sex, age, race, income) at the census tract level based
on two data sources:

- Marginal distribution of one or two variables at the census tract level
  (~ a few thousands people) from the American Community Survey (ACS) 
- Individual-level data from the Public Use Microdata Samples (PUMS) given at the
  larger scale of Public Use Microdata Area (PUMA) ~100,000 people

These distributions will then be input into the risk factor models developed with 
the BRFSS (Behavioral Risk Factor Surveillance System) data to compute aggregate
risk factors (e.g. for diabetes, heart disease) for each census tract.

This code implements the two-step iterative proportional fitting (IPF) method described in:

Beckman, R.J., Baggerly, K.A. and McKay, M.D. (1996) "Creating synthetic
baseline populations." Transportation Research Part A 30, 415-429.


## Data needs

Prior to running the `pums_data_prep.R` script, PUMS (microdata) files must be
downloaded from: http://www2.census.gov/programs-surveys/acs/data/pums/2014/5-Year/ .

The required files include person-level (`csv_p[..].zip`) and household-level
(`csv_h[..].zip`) records where [..] is the state abbreviation (i.e. dc, md or va).

ACS data tables are downloaded as part of the `acs_data_prep.R` script using the
`acs` package in R.


## Helper files

`income_map.csv`, `race_map.csv`, `sex_age_map.csv`: Used in `acs_data_prep.R` to map variable codes from the ACS data tables to the categories present in BRFSS.

`hhsize_map`: Convert variable codes from household size ACS data table to actual household size.

`state_counties.csv`: List of state and counties for which estimates are desired,
based on the area served by the CAFB (Capital Area Food Bank)

`tract_puma_map.csv`: Links each census tract to the corresponding PUMA. This
file was downloaded from: http://www.census.gov/geo/maps-data/data/centract_rel.html .


## Process overview

**pums\_data\_prep.R**

For each of the three states (DC, MD and VA), processes the raw
PUMS microdata (individual rows for each person / household) to extract the variables
of interest (sex, age, race, household income), match to categories from BRFSS
and compute the aggregated counts for each PUMA and combination of demographic variables.

This script also outputs a table of household coutns by household size and
income bracket in order to help convert ACS household counts to person counts 
(see below).

Notes:

- The first two years of the 5-year PUMS (2010, 2011) use the old (2000) PUMA
delinations, which may not overlap with the same census tracts as the 2010 PUMA. 
Therefore, we only keep the 2012-2014 records. 
- The outputs are saved in `pums_2012_2014.csv` (main file) and 
`pums_hh_2012_2014.csv` (household size by income bracket).
- While the BRFSS considers Hispanic/Latino ethnicity as a category under race, 
in the census it is a separate (yes/no) question. To match the two datasets, we 
assume that all respondents of Hispanic/Latino origin in census data (PUMS and ACS)
would fall under the "hispanic" category in BRFSS.

**acs\_data\_prep.R**

Downloads the sex by age, race/ethnicity, and household income tables from ACS, 
map those categories to BRFSS categories with the `[income/race/sex_age]_map.csv` 
files, tally the counts by census tract and save the output into files:
`acs2014_[income/race/sex_age].csv`. 

Additionally, it downloads and saves a table of total and group quarter population
by census tract (`acs2014_pop.csv`), as well as the distribution of household size
by census tracts (`acs2014_hhsize.csv`). These two tables are used in the conversion
of household counts to person counts.

Note:

- To run this script, you need a census API key, which can be requested at: 
http://api.census.gov/data/key_signup.html .

**ipf.R**

Using the PUMS and ACS data files generated by the previous scripts, this script
performs the two-step IPF procedure to jointly estimate the detailed demographic 
breakdown (a so-called "synthetic population") for all census tracts that are 
part of each PUMA. This four-way table (sex, age, race and income) is the output
of the `ipf_4D` function in the second part of the script. However, this final 
IPF requires the distribution of *person* counts per income bracket at the census
tract level, whereas ACS only  provides a distribution of *household* counts. 

To convert from household to person counts, we need a two-way table of household 
size by household income for each census tract. It doesn't exist in ACS, but it
can be estimated once again via IPF, based on the two-way table we have at the 
PUMA level and the marginal distributions of HH size and income per tract. Since 
all households of 7 or more people are lumped in one category by ACS, they are 
assigned the mean size of all 7+ people households from PUMS (~8.7 people) for
the sake of this household to person count conversion.

The population in group quarters (e.g. student dormitories, retirement homes, 
prisons) is accounted for in all variables except income. Therefore, we assign
them a dummy income category "GQ". In the end, we drop the group quarter residents
from the synthetic population since the logistic regression derived from BRFSS requires 
income data. We also drop the 0-17 age group since the BRFSS data starts at age 18. 
